name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - '.github/ISSUE_TEMPLATE/**'
      - 'fastlane/**'
  workflow_dispatch:
    inputs:
      run_all_builds:
        description: 'Run all platform builds'
        required: false
        default: false
        type: boolean

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.38.4'
  JAVA_VERSION: '17'

jobs:
  # ============================================================
  # Path Detection - Determine which platforms need building
  # ============================================================
  changes:
    name: Detect Changes
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      core: ${{ steps.filter.outputs.core }}
      android: ${{ steps.filter.outputs.android }}
      windows: ${{ steps.filter.outputs.windows }}
      ios: ${{ steps.filter.outputs.ios }}
      macos: ${{ steps.filter.outputs.macos }}
      linux: ${{ steps.filter.outputs.linux }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'lib/**'
              - 'pubspec.yaml'
              - 'pubspec.lock'
              - 'test/**'
              - 'assets/**'
              - '.github/workflows/**'
            android:
              - 'android/**'
            windows:
              - 'windows/**'
            ios:
              - 'ios/**'
            macos:
              - 'macos/**'
            linux:
              - 'linux/**'

  # ============================================================
  # Code Quality Checks (Always runs)
  # ============================================================
  code-quality:
    name: Code Quality
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code (build_runner)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Format generated files
        run: dart format .

      - name: Upload generated code
        uses: actions/upload-artifact@v4
        with:
          name: generated-code
          path: lib/**/*.g.dart
          retention-days: 1

      - name: Check formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: Analyze code (strict - errors fail build)
        run: flutter analyze --no-fatal-warnings --no-fatal-infos

      - name: Report all issues (informational)
        run: |
          echo "::group::Flutter Analyze Full Report"
          flutter analyze 2>&1 || true
          echo "::endgroup::"

  # ============================================================
  # Unit Tests with Coverage
  # ============================================================
  test:
    name: Tests
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Download generated code
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: lib/

      - name: Get dependencies
        run: flutter pub get

      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Check coverage threshold
        run: |
          sudo apt-get update && sudo apt-get install -y lcov
          lcov --summary coverage/lcov.info > coverage_summary.txt 2>&1 || true
          cat coverage_summary.txt
          COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | sed 's/.*: //' | sed 's/%.*//' | head -1)
          if [ -z "$COVERAGE" ]; then
            echo "::warning::Could not determine coverage percentage"
            exit 0
          fi
          echo "Coverage: ${COVERAGE}%"
          THRESHOLD=50
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::warning::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
          else
            echo "::notice::Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"
          fi

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  # ============================================================
  # Code Complexity Analysis
  # ============================================================
  complexity:
    name: Code Complexity
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Download generated code
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: lib/

      - name: Get dependencies
        run: flutter pub get

      - name: Install dart_code_linter
        run: dart pub global activate dart_code_linter

      - name: Run code complexity analysis
        run: |
          echo "::group::Code Complexity Report"
          dart pub global run dart_code_linter:metrics analyze lib \
            --reporter=console \
            --cyclomatic-complexity=15 \
            --lines-of-code=150 \
            --number-of-parameters=5 \
            --maximum-nesting-level=4 || true
          echo "::endgroup::"

  # ============================================================
  # Security Scan
  # ============================================================
  security:
    name: Security Scan
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Check for outdated packages
        run: |
          echo "::group::Outdated Packages"
          flutter pub outdated
          echo "::endgroup::"

      - name: Audit dependencies
        run: |
          flutter pub deps --json > deps.json
          echo "::group::Dependency Analysis"
          cat pubspec.lock | grep -E "name:|version:" | head -50
          echo "::endgroup::"

  # ============================================================
  # Platform Builds (Smart - only affected platforms)
  # ============================================================
  build-windows:
    name: Build Windows
    needs: [changes, code-quality]
    if: |
      !github.event.pull_request.draft &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.windows == 'true' || github.event.inputs.run_all_builds == 'true')
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~\AppData\Local\Pub\Cache
          key: pub-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Download generated code
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: lib/

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows (Release)
        run: flutter build windows --release

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-${{ github.sha }}
          path: build/windows/x64/runner/Release/
          retention-days: 3

  build-macos:
    name: Build macOS
    needs: [changes, code-quality]
    if: |
      !github.event.pull_request.draft &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.macos == 'true' || github.event.inputs.run_all_builds == 'true')
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Cache CocoaPods
        uses: actions/cache@v5
        with:
          path: |
            macos/Pods
            ~/.cocoapods
          key: pods-macos-${{ hashFiles('macos/Podfile.lock') }}
          restore-keys: |
            pods-macos-

      - name: Download generated code
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: lib/

      - name: Get dependencies
        run: flutter pub get

      - name: Build macOS (Release)
        run: flutter build macos --release

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-${{ github.sha }}
          path: build/macos/Build/Products/Release/
          retention-days: 3

  build-linux:
    name: Build Linux
    needs: [changes, code-quality]
    if: |
      !github.event.pull_request.draft &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.linux == 'true' || github.event.inputs.run_all_builds == 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev
          sudo apt-get install -y libsecret-1-dev libayatana-appindicator3-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Download generated code
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: lib/

      - name: Get dependencies
        run: flutter pub get

      - name: Build Linux (Release)
        run: flutter build linux --release

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build-${{ github.sha }}
          path: build/linux/x64/release/bundle/
          retention-days: 3

  build-android:
    name: Build Android
    needs: [changes, code-quality]
    if: |
      !github.event.pull_request.draft &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.android == 'true' || github.event.inputs.run_all_builds == 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Cache Gradle
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Download Spotify App Remote SDK
        run: |
          mkdir -p android/spotify-app-remote
          curl -L -o android/spotify-app-remote/spotify-app-remote.aar \
            https://github.com/spotify/android-sdk/raw/master/app-remote-lib/spotify-app-remote-release-0.8.0.aar

      - name: Download generated code
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: lib/

      - name: Get dependencies
        run: flutter pub get

      - name: Build Android APK (Release)
        run: flutter build apk --release

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build-${{ github.sha }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 3

  build-ios:
    name: Build iOS
    needs: [changes, code-quality]
    if: |
      !github.event.pull_request.draft &&
      (needs.changes.outputs.core == 'true' || needs.changes.outputs.ios == 'true' || github.event.inputs.run_all_builds == 'true')
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Cache CocoaPods
        uses: actions/cache@v5
        with:
          path: |
            ios/Pods
            ~/.cocoapods
          key: pods-ios-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            pods-ios-

      - name: Download generated code
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: lib/

      - name: Get dependencies
        run: flutter pub get

      - name: Build iOS (No Codesign)
        run: flutter build ios --release --no-codesign

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ github.sha }}
          path: build/ios/iphoneos/
          retention-days: 3
